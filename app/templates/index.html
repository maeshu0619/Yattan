<!doctype html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <title>YATTAN | タスクチェック共有アプリ</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />

  <!-- あなたの元のCSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}" />

  <!-- 立体PUSHボタン用CSS -->
  <link rel="stylesheet" href="{{ url_for('static', filename='css/style_button.css') }}" />
</head>

<body class="bg-body-tertiary">

<header class="ytn-hero shadow-sm">
  <div class="container py-4">
    <div class="d-flex flex-wrap align-items-end justify-content-between gap-3">
      <div>
        <div class="d-inline-flex align-items-center gap-2">
          <span class="ytn-logo rounded-3 d-inline-flex align-items-center justify-content-center">
            <i class="bi bi-check2-circle"></i>
          </span>
          <h1 class="ytn-title mb-0">YATTAN</h1>
        </div>
        <p class="text-white-50 mb-0 mt-1">タスクチェック共有アプリ</p>
        <p class="text-white-50 mb-0 mt-1">ver 3.3</p>
      </div>
      <div class="ytn-date badge text-bg-light text-dark fs-6">
        <i class="bi bi-calendar3 me-1"></i>{{ today }}
      </div>
    </div>
  </div>
</header>

<main class="container py-5">

<!-- ===== てつ（犬） ===== -->
<div class="row g-4 mt-2">
  {% for dog in DOGS %}
  <div class="col-12 col-md-6 col-lg-4">
    <div class="card ytn-card h-100 border-0 shadow-sm">
      <div class="card-body d-flex flex-column">

        <div class="d-flex align-items-center gap-2 mb-3">
          <img class="avatar" src="{{ url_for('static', filename='images/dog.jpg') }}">
          <h5 class="card-title mb-0">{{ dog }}</h5>
        </div>

        <div class="d-grid gap-2">
          {% for t in TIMES_DOG %}
          {% set fed = state[(dog, t)] %}
          <button type="button"
                  class="btn btn-lg ytn-toggle w-100 d-flex justify-content-between {{ 'is-done' if fed else 'is-undone' }}"
                  data-dog="{{ dog }}"
                  data-time="{{ t }}">
            <span class="d-flex align-items-center gap-2">
              <i class="bi {{ 'bi-check-circle-fill' if fed else 'bi-circle' }}"></i>
              <span>{{ t }}</span>
            </span>
            <span class="status small">{{ '完了' if fed else '未' }}</span>
          </button>
          {% endfor %}
        </div>

      </div>
    </div>
  </div>
  {% endfor %}
</div>


<!-- ===== ぽんず（猫） ===== -->
<div class="row g-4 mt-2">
  {% for cat in CATS %}
  <div class="col-12 col-md-6 col-lg-4">
    <div class="card ytn-card h-100 border-0 shadow-sm">
      <div class="card-body d-flex flex-column">

        <div class="d-flex align-items-center gap-2 mb-3">
          <img class="avatar" src="{{ url_for('static', filename='images/cat.jpg') }}">
          <h5 class="card-title mb-0">{{ cat }}</h5>
        </div>

        <div class="d-grid gap-2">
          {% for t in TIMES_CAT %}
          {% set fed = state[(cat, t)] %}
          <button type="button"
                  class="btn btn-lg ytn-toggle w-100 d-flex justify-content-between {{ 'is-done' if fed else 'is-undone' }}"
                  data-dog="{{ cat }}"
                  data-time="{{ t }}">
            <span class="d-flex align-items-center gap-2">
              <i class="bi {{ 'bi-check-circle-fill' if fed else 'bi-circle' }}"></i>
              <span>{{ t }}</span>
            </span>
            <span class="status small">{{ '完了' if fed else '未' }}</span>
          </button>
          {% endfor %}
        </div>

      </div>
    </div>
  </div>
  {% endfor %}
</div>


<!-- ===== 通常業務 ===== -->
<div class="row g-4 mt-2">
  <div class="col-12 col-md-6 col-lg-4">
    <div class="card ytn-card h-100 border-0 shadow-sm">
      <div class="card-body d-flex flex-column">

        <div class="d-flex align-items-center gap-2 mb-3">
          <img class="avatar" src="{{ url_for('static', filename='images/normal.jpg') }}">
          <h5 class="card-title mb-0">通常業務</h5>
        </div>

        <div class="d-grid gap-2">
          {% for task in OPTIONAL_TASKS %}
          {% set done = optional_state[task] %}
          {% set rec = optionals | selectattr("name","equalto",task) | first %}
          <button type="button"
                  class="btn btn-lg ytn-toggle w-100 d-flex justify-content-between {{ 'is-done' if done else 'is-undone' }}"
                  data-task="{{ task }}">
            <span class="d-flex align-items-center gap-2">
              <i class="bi {{ 'bi-check-circle-fill' if done else 'bi-circle' }}"></i>
              <span class="fw-semibold">{{ task }}</span>
            </span>
              <span class="status small">
                {% if task == "ぽんずトイレ" %}
                  {{ rec.count }}回
                {% else %}
                  {{ '完了' if done else '未' }}
                {% endif %}
              </span>
          </button>
          {% endfor %}
        </div>

      </div>
    </div>
  </div>
</div>

<!-- ===== PUSH送信ボタン ===== -->
<div class="text-center mt-5">
  <a id="submitBtn" class="btn btn-custom01">
    <span class="btn-custom01-front">PUSH</span>
    <i class="fas fa-angle-right fa-position-right"></i>
  </a>
</div>

<!-- 右下お知らせボタン -->
<div id="infoFab">
  <i class="bi bi-envelope-fill"></i>
</div>

<!-- お知らせパネル -->
<div id="infoPanel">
  <div class="infoHeader">
    <span>アップデート情報</span>
    <button id="infoClose">✕</button>
  </div>
  <div class="infoBody">
    <ul>
      <li>ボタンを選択してからまとめて送信できるようになりました</li>
      <li>てつのタスクの”薬”を削除しました</li>
      <li>通常業務に”電気点灯”を追加しました</li>
      <li>通常業務の”ぽんずトイレ”を回数カウントにしました</li>
    </ul>
  </div>
</div>

</main>

<script>
const pending = {};

// 初期状態を記録（DBの状態）
document.querySelectorAll(".ytn-toggle").forEach(btn => {
  btn.dataset.original = btn.classList.contains("is-done") ? "1" : "0";
});

document.querySelectorAll(".ytn-toggle").forEach(btn => {
  btn.addEventListener("click", () => {
    const dog  = btn.dataset.dog || "";
    const time = btn.dataset.time || "";
    const task = btn.dataset.task || "";

    const key = task !== "" ? "task|" + task : "feed|" + dog + "|" + time;

    const original = btn.dataset.original === "1"; // DBの元の値
    const pendingNow = btn.classList.contains("is-pending");

    // pending をトグル
    if (pendingNow) {
      btn.classList.remove("is-pending");
      delete pending[key];
    } else {
      btn.classList.add("is-pending");
      pending[key] = !original;
    }
  });
});

document.getElementById("submitBtn").addEventListener("click", () => {
  if (Object.keys(pending).length === 0) return;

  fetch("/bulk_update", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(pending)
  }).then(() => location.reload());
});


const fab = document.getElementById("infoFab");
const panel = document.getElementById("infoPanel");
const closeBtn = document.getElementById("infoClose");

fab.addEventListener("click", () => {
  panel.style.display = "block";
  fab.style.display = "none";
});

closeBtn.addEventListener("click", () => {
  panel.style.display = "none";
  fab.style.display = "flex";
});

function updateCardStatus() {
  document.querySelectorAll(".ytn-card").forEach(card => {
    const buttons = card.querySelectorAll(".ytn-toggle");
    if (buttons.length === 0) return;

    const allDone = Array.from(buttons).every(btn =>
      btn.classList.contains("is-done")
    );

    card.classList.toggle("is-all-done", allDone);
  });
}

// 初回ロード時
updateCardStatus();

// PUSH後に反映
document.getElementById("submitBtn").addEventListener("click", () => {
  setTimeout(updateCardStatus, 500);
});

</script>





</body>
</html>
